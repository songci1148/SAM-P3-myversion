#!/bin/bash
### Job Name
#PBS -N testP3ice_128x128
### Project  Code 
#PBS -A UWAS0108
#PBS -l walltime=00:07:00
#PBS -q main
#PBS -l job_priority=economy
###PBS -l job_priority=economy ####PBS -q economy #premium regular
### Merge output and error files
#PBS -k eod
#PBS -j oe
### Send email on abort, begin, and end
#PBS -m abe
#PBS -M blaz.gasparini@univie.ac.at
### select nodes, CPUs, and MPI processed; #NOTE: derecho-specific, see mpiexec -n 128 -ppn 128 .... line! modify if needed! 
#PBS -l select=1:ncpus=128:mpiprocs=128
#PBS -l place=group=rack

### Set TMPDIR as recommended
export TMPDIR=/glade/derecho/scratch/$USER/temp
mkdir -p $TMPDIR

#sleep=12
#MPI_IB_CONGESTED=1
#MPI_LAUNCH_TIMEOUT=40

scriptdir=/glade/work/$USER/SAM/SAM-P3-multi/
case=RCE_minimal_example
subcase=P3ice_128x128x74_first-test
jobfile=$case/resub.$subcase
logfile=log_$case$subcase
prmfile=$case/prm.$subcase
prmloc=$case/prm
#lsffile=$case/lsf.$subcase
#lsfloc=$case/lsf
cluster=derecho
SAMname=./SAM_ADV_UM5_SGS_TKE_RAD_RRTM_MICRO_P3MULTI_tke_frzcat_diag_ffrz_128x128x74_128cpu_16nx_8ny

# Change to correct directory
#\cd $scriptdir
#pwd
#\cp $case/CaseName ./
## Copy prm and lsf files to correct places
#pwd
#echo \cp
#echo $prmfile $prmloc
#\cp $prmfile $prmloc
#echo \cp
##echo $lsffile $lsfloc
##\cp $lsffile $lsfloc

# Change to correct directory
cd $scriptdir
cp $case/CaseName ./
cp $prmfile $prmloc

rm -f ReadyForRestart

if [ ! -e $SAMname ]
    then
    echo Could not find $SAMname
    echo Executable does not exist
    exit 9
fi

### load the modules on cheyenne
if [ ! -z ${NCAR_HOST} ]; then
  echo "NCAR_HOST exists"
  if [ $NCAR_HOST == "cheyenne" ]; then
    source /etc/profile.d/modules.sh
    module purge
#    module load intel/19.0.5 mpt/2.22 netcdf/4.7.4 ncarenv/1.3 ncarcompilers/0.5.0
    module load intel/19.1.1 mpt/2.25 netcdf/4.8.1 ncarenv/1.3 ncarcompilers/0.5.0
    module list
  fi

  if [ $NCAR_HOST == "derecho" ]; then
    module list
  fi
fi
#######################

echo "Current directory:"
pwd
echo "Running executable from here."
#permissions 
#chmod +x ${SAMname}
### Run the executable
mpiexec -n 128 -ppn 128 ${SAMname} >> $logfile  ##MAKE IT BETER HERE???

cat timing.0 >> $logfile


### load modules for intel setup
##source /etc/profile.d/modules.sh
##module load intel/13.1.1 openmpi/1.6.4 netcdf/4.3.0-oly01
##export LD_LIBRARY_PATH=/usr/local/modules/openmpi/1.6.4/intel/13.1.1/lib:${LD_LIBRARY_PATH}
##
##cat >$SAMname.sh <<EOF
###!/bin/sh
##ulimit -s unlimited
##exec $SAMname
##EOF
##chmod +x $SAMname.sh
##time mpirun $SAMname.sh >> $logfile
###time mpirun --mca btl tcp,self $SAMname.sh >> $logfile
##
######time mpirun $SAMname >> $logfile
##
#

# Check to see if model is ready for a restart
str1=`fgrep TRUE ReadyForRestart`

if [ "$str1" == "TRUE" ]
    then

    echo It appears the previous run ended properly and job not yet finished.

    # modify nrestart in prm file, so that model will restart
    cat $prmfile | sed s/nrestart.\*=.\*0/nrestart\ =\ 1/ > temp.namelist
    \mv temp.namelist $prmfile
    \cp $prmfile $prmloc

    echo Resubmitting $jobfile
    qsub $jobfile

    # Remove the file that permits restarts to be submitted
    rm -f ReadyForRestart

else
   echo "No restart required (or desired if the run failed)"
fi

exit 0

